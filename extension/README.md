# TBP Advisor（Chrome 扩展）— 使用说明

## 这是什么
- 在 `tetr.io` 的游戏界面上，叠一层半透明的“当前块推荐落点”。
- 点扩展图标 → “打开详情（实时）”，会实时显示当前局面的「当前块 + Next5」推荐步骤（方便边玩边对照）。

> 重要：本扩展 **只提示**，不做任何自动按键/自动操作。

## 引擎说明（现在默认更像“对战”）
- **默认优先用本地 Cold Clear 2（CC2）** 来算“当前块推荐落点”（更强、更像对战）。
  - 你需要在本机启动 `cc2-server/server.js`（见 `cc2-server/README.md`）。
  - 如果扩展连不上本地 CC2：会自动回退到插件内置的 **Cold Clear 1（CC1，WASM，离线）** 兜底。
- 如果你的浏览器不支持 offscreen（或被策略禁用），或者 CC1 的 cold-clear worker 启动失败：兜底也可能跑不起来，这时弹窗/详情页会给你更明确的错误提示。
- 如果你看到 `wasm 初始化失败：...Content Security Policy...`：说明当前扩展页面 CSP 不允许编译 WASM。我们已在扩展里开启 `wasm-unsafe-eval`（需要重新加载扩展后生效）；如果你是公司/网吧电脑被策略禁了，那就尽量用“本地 CC2”路线。

## 怎么装（开发者模式）
1. 打开 Chrome → 访问 `chrome://extensions/`
2. 右上角打开「开发者模式」
3. 点「加载已解压的扩展程序」
4. 选择本项目的 `extension/` 文件夹

## 怎么用
1. 打开 `https://tetr.io/` 并进入一局（40L 或 对战都行）
2. 扩展会自动尝试读取状态：能读到就会在棋盘上画出推荐落点
3. 点扩展图标：
   - 可以开关叠加提示、调透明度、是否允许用 Hold、切换 40L/对战预设
   - 点「打开详情（实时）」会打开详情页并跟随游戏实时更新
   - 如果绿色提示跟格子对不上：点「校准棋盘位置」，回到游戏页面拖动绿色框，让它刚好盖住棋盘的 10x20 可见区域，然后点“保存校准”

## 常见问题
### 1）提示不出来 / 说“读不到状态”
可能原因：
- 还没进入对局（在主菜单/观战等状态）
- tetr.io 更新导致内部对象结构变了

如果弹窗状态显示：
- **“正在连接…”**：通常是刚刷新页面，等一两秒再看。
- **“页面 Hook 没响应（可能被网站拦了）”**：先试试 `chrome://extensions/` 里点“重新加载”扩展，再回 tetr.io 按 `Ctrl+R` 刷新。

你也可以在设置页打开「调试模式」，然后在开发者工具 Console 里搜 `[TBP]` 看更具体的提示。

### 1.2）我想确认现在到底用的是 CC2 还是 CC1？
点扩展图标，状态里会显示一行：
- `引擎=cold-clear-2`：说明正在用本地 CC2
- `引擎=cold-clear-v1`：说明回退到了插件内置 CC1（通常是你没开本地服务，或连不上）

### 1.5）提示出来了，但“对不齐 / 太大 / 偏一点点”
不同分辨率、浏览器缩放、皮肤、甚至显示器 DPI 都可能让我们自动算出来的棋盘框差一点点。
解决办法：在弹窗里点「校准棋盘位置」，手动把绿色框对齐一次即可（保存后会记住，并且会锁定，避免下一步又跳）。

小技巧：校准时你可以先拖到差不多的位置，然后点一下“吸附对齐”，它会把框吸附成更标准的 10x20 网格，方便你微调。

如果你发现“窗口缩小后还是不准”，可以用弹窗里的「测缩放系数（采样）」：按页面提示改窗口大小 + 校准 + 记录样本，最后复制 JSON 发给我，我会用这些样本把缩放适配做得更准。

### 2）“读取完整块序”是什么？
默认只用 Next5 来算（更“正常”）。
打开「读取完整块序」会让建议更强（更愿意做长远规划），默认开启；你也可以关掉做对比（更快但更弱）。
