# 模块：ui（叠加层 + 详情页实时）

## 目的
让玩家“看得懂、不会挡视线、能随时看清为什么这么建议”。

## 模块概述
- **职责:** 画叠加层；弹窗/详情页展示实时完整摆法；设置开关
- **状态:** ✅MVP已实现
- **最后更新:** 2026-02-15
- **参考:** `ref/tetrismind/`（仅参考 UI/交互与棋盘展示方式）

## 现状（现在代码怎么做的）
相关代码在：
- 叠加层：`extension/content/overlay.js` + `extension/content/content.js`
- 弹窗：`extension/ui/popup.html` / `popup.js`
- 详情页（实时）：`extension/ui/details.html` / `details.js`
- 设置页：`extension/ui/options.html` / `options.js`

现在的行为是：
- 默认在棋盘上画“当前块建议落点”（半透明绿色轮廓）。
- 点扩展图标 → 可以开关、调透明度、切换 40L/对战、开关 Hold。
- 弹窗状态里会显示当前使用的引擎（例如 `cold-clear-2` / `cold-clear-v1`），方便你确认现在到底跑的是 CC2 还是回退到 CC1。
- 弹窗会显示当前“对齐来源”（例如 `自动(PIXI)` 或 `校准/采样`），方便你一眼判断现在到底用的是哪套对齐方式。
- 弹窗新增「强制重置（清缓存）」：用于“退出对局再进 / 切模式后卡在旧局面、块序/地形对不上”的情况；它会清掉扩展内存缓存，并要求页面重新捕获游戏 API（通常 1-2 秒内恢复）。
- 点“打开详情（实时）”：会打开详情页，跟着游戏实时更新，展示「当前块 + Next5」推荐步骤。
- 详情页里有两种视图：
  - **实时落点（默认）**：这一步“现在应该怎么放”（叠加层也画的就是这个，以此页为准）。
  - **预览后续（点右侧步骤）**：只是让你看看“如果按模拟规划走，后面可能怎么放”，只影响这一页展示；点“回到实时”就会回到默认显示。
- 详情页棋盘默认只显示“可见 20 行”，避免因为 bufferRows 把棋盘拉得很高；只有当高亮格子确实超出上边界时，才会在顶部按需加行，并在分界线处画一条线。
- 弹窗新增“对齐模式”：
  - **自动（PIXI）**：优先用游戏渲染层自己给出的棋盘位置（窗口怎么缩放都会跟着变），通常不需要你手动校准。
  - **校准/采样（兜底）**：当自动对齐不准/拿不到时，你可以切到这个模式，然后再用手动校准 + 采样建模来解决。
- 为了不打扰你：**只有在“校准/采样（兜底）”模式下**，弹窗才会显示“校准棋盘位置 / 复制校准参数 / 测缩放系数（采样）/ 管理采样点”等按钮。
- 如果提示没贴格子：切到“校准/采样（兜底）”，点“校准棋盘位置”，会在游戏页面出现一个可拖拽的绿色框；你拖到刚好盖住 10x20 可见棋盘后点“保存校准”，之后就会更稳地对齐。
- 如果你缩放窗口导致棋盘大小变化：扩展会检测到窗口尺寸变化，然后用“最新识别到的棋盘位置 + 你的校准偏移”自动重算并更新叠加层（极端情况下仍可再校准一次）。
- 设置页里可以开关“读取更长块序”：默认开启更强，但你也可以关掉做对比（更快但更弱）。
- 设置页里可以选择“引擎优先级”：
  - 优先本地 CC2（推荐）：需要你先启动 `cc2-server`；连不上会自动回退 CC1
  - 只用插件 CC1（兜底）：完全离线，但有时会受浏览器策略/CSP/offscreen 影响
- 如果引擎暂时算不出来（超时/worker 崩了等）：实时叠加层会先不显示建议，并在详情页里把原因写出来，避免回退到另一套逻辑导致你看到“悬浮和详情页不一致”。

### 需求: 缩放采样（缩小系数）
**模块:** ui  
当你觉得“窗口缩小后叠加层还是不准”，我们提供一个“采样工具”帮你快速收集数据：
- 弹窗里点「测缩放系数（采样）」会打开一个采样页。
- 采样页会教你用“只改宽/只改高/极端情况”这种方式测十几次。
- 每次你校准并保存后点「记录当前样本」，它会把：窗口大小、自动识别棋盘框、你校准的棋盘框、校准偏移参数都存起来。
- 你点「复制样本 JSON」发给我，我就能基于这些样本建模，推算缩放时更准确的缩放/偏移策略。

## 规范

### 需求: 实时叠加层（只画当前块建议）
**模块:** ui  
默认只画“当前块怎么放”：
- 预期结果：半透明、不刺眼、不挡住原棋盘信息
- 预期结果：能一键开关、可调透明度
- 预期结果：不同电脑/缩放下如果对不齐，用户能手动校准一次解决

### 需求: 详情页（实时）
**模块:** ui  
当用户点开详情页：
- 预期结果：详情页跟随游戏实时变化
- 预期结果：能看到「当前块 + Next5」的完整摆法建议（步骤列表）

## 依赖
- state（提供实时状态）
- engine（提供建议与完整摆法）
