# Changelog

本文件记录项目所有重要变更。
格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/),
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [Unreleased]

### 新增
- 初始化 HelloAGENTS 知识库结构与规划方案包（仅文档）。
- Chrome 扩展 MVP（`extension/`）：叠加层提示 + 弹窗 + 详情页快照 + 设置页。
- 本地引擎路线（CC2）：新增 `cc2-server/`，扩展可优先请求本机 Cold Clear 2 服务计算落点；连不上会自动回退 CC1（WASM）兜底。
- 本地引擎路线（MisaMino）：新增 `misamino-server/`，扩展可切到本机 MisaMinoBot（只看 next5）计算落点；连不上会自动回退 CC1（WASM）兜底。
- 设置页新增“引擎优先级 / 本地 CC2 地址 / CC2 超时”三项，方便一键切换和排错。
- 设置页新增“本地 MisaMino 地址 / MisaMino 超时”，用于不常开 CC2 的场景。
- 设置页新增候选挑选策略：`仿 CC2 默认权重（仅 CC1）`，用于在不开本地 CC2 时让 CC1 更“像对战”一点。
- A 路线取状态（页面内 Hook）：用 tetr.io 内部 `ejectState()` 拿 board/current/hold/next，并计算棋盘屏幕位置用于叠加层定位。
- 占位引擎（Worker）：当前块建议落点 + 快照时计算“当前块 + Next5”的步骤列表（后续再接 cold-clear WASM）。
- 离线引擎（Cold Clear v1 / WASM）：叠加提示默认改为走 offscreen + WebWorker 跑 cold-clear（更像对战思路）。
- 叠加层「手动校准」：弹窗一键进入校准模式，拖动四角让绿色框刚好贴住棋盘后保存（适配不同分辨率/缩放/皮肤）。
- 校准辅助：校准工具栏新增“吸附对齐”，先拖到大概位置再点一下会吸附到更标准的 10x20 网格。
- 弹窗工具：新增“复制校准参数”，方便把当前校准值发出来做备份/写入默认值。
- 弹窗工具：新增「强制重置（清缓存）」按钮：清空异常缓存并要求页面重新捕获游戏 API，用于“切模式/退局再进后卡在旧局面”。
- 7-bag 预判增强（变长队列）：开启“读取完整块序”时，会按分袋边界把队列喂给 cold-clear（6 → 12 → … → 6 循环），兼顾“更聪明”与“别太慢”。
- 缩放采样工具：弹窗新增「测缩放系数（采样）」入口，用于收集“窗口大小 + 自动识别框 + 校准框”样本，方便后续建模优化缩放适配。

### 修复
- 页面内 Hook 扫 `window` 时跳过跨域 iframe，避免报 `SecurityError` 导致“未连接（读不到状态）”。
- 增强“自检/注入”：新增后台 `sw.js` 用 `chrome.scripting` 注入 MAIN 世界脚本，减少被 CSP 拦截导致 Hook 不运行的概率。
- 新版 tetr.io 不一定把“游戏 API 对象”挂到 `window`：Hook 改为通过监听 `Map.set/get` 捕获 API，并自动卸载监听，解决“未找到游戏 API”。
- 叠加层偶发不显示：棋盘定位（bounds）改为“多对象/多 canvas 自动择优”，并在弹窗状态里显示“状态/定位/建议”三项，方便排查。
- 叠加层一直不显示：修正棋盘格子“空值”解析（兼容 `0/-1/255`），并用棋盘真实高度推断 `bufferRows`，避免建议算不出来或画到看不见的位置。
- 修复控制台报错：Content Script 里不能直接 `new Worker(chrome-extension://...)`（会被当成 https 页面跨域加载而被拦），所以改为直接在 Content Script 做本地计算（后续再升级到更稳的离线方案）。
- 叠加层对不齐/看起来变大：在高 DPI 下更稳地选择 bounds，并按 `bufferRows/visibleRows` 自动把“包含隐藏 buffer 的 bounds”裁剪为只覆盖可见棋盘；弹窗同步显示 bounds 来源与缩放信息，方便用户截图反馈。
- 详情页离开对局/切模式后还停留上一局：读不到实时状态时会清空旧画面与步骤。
- Cold Clear 实际没启用（弹窗一直显示 `引擎=sim`）：修复 offscreen 文档创建 reason，避免浏览器直接拒绝创建导致整条链路回退。
- 引擎仍回退 `sim` 时难以排错：弹窗会显示更明确的 cold-clear 回退原因（不需要打开调试模式）。
- 校准后放一块提示又变大：校准会额外锁定“绝对像素框”，并对老版本校准数据做自动迁移，避免下一步漂移。
- cold-clear 经常超时：避免每一步都 `stop/start` 重启引擎；如果玩家按建议落点走，会用 `play/new_piece` 增量推进，速度更稳。
- cold-clear 增量推进在 readFullBag=true 时容易把 `new_piece` 发错（导致状态跑飞/崩溃回退）：改为按“队列长度变化”一次补齐 0~N 个 `new_piece`，并用 `advanceBy` 明确这一手消耗了几个队列块。
- cold-clear WASM 被 CSP 拦截导致启动失败：扩展页面 CSP 增加 `wasm-unsafe-eval`（重新加载扩展后生效；若设备策略禁用则仍会回退简化引擎）。
- cold-clear 内部 worker 路径兼容：补一个扩展根目录的 `extension/worker.js` 兜底，避免某些环境解析 `worker.js` 相对路径失败导致崩溃回退。
- cold-clear 打一段时间后偶发 `RuntimeError: unreachable` 崩溃回退：修复短队列（current+next5）时 `bag_state` 计算方式，改为只从“队列末尾”反推，避免跨袋重复导致 randomizer 状态不可能。
- cold-clear 偶发“明明算完了但我这里显示超时”：修复 `_waitFor` 超时后 waiter 未清理导致的“串消息/假超时”。
- Zen 撤回/重开/退出对局后 cold-clear 容易串状态：检测到“无状态”或帧号倒退时主动 reset cold-clear。
- Zen 撤回/重开（帧号倒退）时：目前按“立即 reset cold-clear”处理，优先保证不同步不串状态；后续如果你又想要“防抖 + 限流”，再加回来。
- 偶发出现“cold-clear 建议了一个根本不存在的块”（例如建议 I，但当前/hold/next1 都没有）：增加合法性校验；检测到不同步时会强制重启并重算一次，仍异常则明确报错，避免画出错误提示。
- 兼容不同 tetr.io 版本：如果 `game.bag[0]` 偶尔包含当前块，会自动丢掉，避免 next 队列错位导致引擎不同步。
- 对战模式“更像会打旋转”：当 cold-clear 返回多个候选落点时，`对战 + tspins` 会优先选择 T-Spin 落点（如果候选里有），避免我们死板地永远只取第 1 个导致看起来“只会消行”。
- 悬浮提示与详情页偶发不一致（尤其 Zen undo/回退到同一局面时）：为 cold-clear 请求加入 `requestId`，回包必须匹配当前 in-flight 才会更新，避免旧回包“回魂覆盖”。
- 窗口缩放后对不齐：锁定模式下不再依赖 storage 里的旧视口值做判断，改为用内存记录更可靠地检测 resize，并在 resize 后用最新识别到的棋盘位置重算并更新锁定框。
- 窗口缩放后仍可能对不齐：加入 `scaleSamples` 自适应建模——窗口大小变化时会优先套用“同窗口大小下的校准样本”去重算锁定框；并把“保存校准”和“保存为样本”拆开，避免随手校准就污染样本模型（只有点“保存为样本”才会写入 `scaleSamples`）。
- 棋盘 bounds 自动识别更稳：优先使用 tetr.io `getHolderData()` 携带的 canvas（如果拿得到），减少“选错 canvas 导致偏移”。
- 连续同种块（例如 T、T、T）时偶发“我已经放了但提示没变”：实时计算 key 增加 `frame`，确保每次下块都会触发重算/更新。
- Zen 开局/切局面时偶发“短暂显示上一局建议”（比如开局手里是 S/Z 但显示 I）：现在只在“建议与当前局面匹配”时才会画叠加/显示 cold-clear debug，不匹配就先清空等待新结果。
- 详情页“以谁为准”容易误解：详情页新增“实时/预览后续”状态提示与“回到实时”按钮，减少你感觉“反了”的困惑。
- Hold 相关假矛盾：推断每手 `canHold`（每个块最多 hold 一次），避免出现“刚 hold 完又建议再 hold 一次”的不合法建议。
- 修复 `canHold` 误判：开局/倒计时/生成新块时 `current` 可能变化，但不代表玩家按过 hold；现在只在“确实发生了 hold 交换/消耗 next”时才判定本手已 hold，避免出现“游戏里能 hold，但详情页显示可Hold=否”。
- undo/重算一致性：增加“同局面复用”缓存，同一个局面（含喂给 cc 的块序）算过一次就复用，避免“撤回回去建议又变了”。
- Hold 前后一致性：当建议“先 Hold 再放某块”时，会把“按下 Hold 后的局面”也预先写入一致性缓存，避免你按下 Hold 后同一块的落点又换一个位置。
- 修复 TBP 坐标换算：按 TBP spec 修正 I/O 在不同朝向的中心点；并增加“落点合法性校验”（越界/压到已有块/坐标非整数会报错并 reset cold-clear），避免画出“不可能落点”。
- 悬空落点兜底：如果检测到“建议落点整体还能往下掉 1 格”，视为不同步；会自动 reset 引擎一次并等待重算，仍异常则提示你点「强制重置（清缓存）」或刷新。
- 状态心跳超时：一段时间收不到页面消息时会清空旧局面并提示你重置/刷新，避免卡在“上一局画面/块序”误导你。
- 退出对局再进后偶发“状态卡在上一局”：pageHook 增加 `frame` 卡死检测，发现长时间不变会自动 ban 旧 API 并重抓，避免 keepalive 旧状态导致 content 误以为还在实时更新。
- 双人练习/准备阶段误报“状态超时”：页面 Hook 增加 keepalive（局面不变也会定期发一次），避免 content 侧把“没变化”误判成“卡死”。
- 强制重置更不容易“重置成断开”：重置捕获时如果暂时抓不到新的 API，会保留旧 API 兜底，避免你在对局中点了重置反而变成“未找到游戏 API”。
- 强制重置更“无感”：手动重置捕获改为 soft reset（对局中默认不清空旧 API），只有在明确卡死/长时间无完整状态时才 hard reset 重抓，减少“点完重置反而坏了”的概率。
- 引擎“返回不可能的块”（例如当前=L 却建议 J）：增加 `piece_mismatch` 校验；检测到不可能块会自动 reset 引擎一次并等待重算，避免画出错误提示。
- 本地 MisaMino：服务端增加返回合法性校验与自动重试；超时/异常会硬重启子进程，避免旧回包污染导致不同步。
- 堆高/出生点在上方缓冲区时：详情页现在**默认只画可见 20 行**；只有当高亮格子真的超出上边界时，才按需在顶部加行数，并在分界线位置画一条线；同时也支持显示 `y < 0` 的高亮格子。
- 自动(PIXI) 对齐更稳：减少选到“堆叠方块包围盒（会抖）”的概率，并加短缓存避免跟着方块抖；叠加层在自动模式下会做一次保守的“格子正方形收敛”，让大小更接近手动校准。

### 变更
- 详情页改为**实时显示**（暂时不做“快照/上一条/下一条”）。
- “读取更长块序”默认开启：仍保留设置开关，方便你随时关闭做对比（关闭后会退回只看 Next5 的短队列）。
- 校准在窗口缩放后失效：检测到视口尺寸变化时，会用相对比例自动重算并更新锁定棋盘框，减少缩放后对不齐。
- 实时建议不再回退到 `sim`：cold-clear 失败时先不显示建议，并在详情页/状态里给出更明确的原因（避免两套逻辑导致“看起来同步但其实不一致”）。
- 弹窗新增“对齐模式（自动PIXI / 校准采样）”，并且校准/采样相关按钮只在“校准/采样”模式下显示（减少弹窗干扰）。
- 弹窗按钮收敛：把“复制校准参数 / 测缩放系数（采样）/ 管理采样点”整合进一个“校准/采样工具”入口，避免主弹窗按钮过多。

### 变更（调试增强）
- 弹窗状态增加更多信息（current/board尺寸/引擎原因），用于定位“为什么建议❌”。
- 弹窗/详情页：补充显示 cold-clear 的上下文（阶段/超时阈值/worker 是否崩溃），方便你截图反馈。
- 详情页：新增「复制调试包」按钮，一键打包当前状态/建议/关键设置 + pageHook 环形日志，方便定位“卡在上一局/不同步/读不到状态”等问题。
