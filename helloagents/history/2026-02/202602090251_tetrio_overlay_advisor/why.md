# 变更提案: TETR.IO 摆放建议叠加层（离线 AI）

## 需求背景
你希望做一个 Chrome 插件，在 TETR.IO 网页游戏里：
- **实时**在棋盘上叠加一个半透明提示：告诉你“当前块建议放哪”
- 点开扩展弹窗/详情页时，抓一份**当下快照**，展示“当前块 + Next5 的完整摆法”
- 插件尽量做到“装上就能用”，不依赖线上服务

---

## 产品分析

### 目标用户与场景
- **用户群体:** 想练 40L、想练对战摆法的玩家
- **使用场景:**
  - 40L：追求更快、更稳的清线节奏
  - 对战：追求更安全、更能打出 T-spin（后续可扩展 all-spin）
- **核心痛点:** 很多时候不是不会放，而是来不及想；希望有个“提醒方向”的提示

### 价值主张与成功指标
- **价值主张:** 让玩家少纠结当前块，更多注意节奏与执行
- **成功指标（验收口径）:**
  - 进入游戏后，叠加层能稳定显示建议（不闪、不偏、不挡视线）
  - 打开详情页会生成快照，并能回看上一条/下一条快照
  - 离线可用：不开任何外部服务也能跑

### 人文关怀
- 默认只做“提示”，不做自动操作，避免变成代打工具
- 默认对竞技匹配/排位保持谨慎（避免违反规则导致封号）

---

## 变更内容
1. **实时叠加层**：只画“当前块”的建议落点（半透明）
2. **详情页快照**：打开时冻结当下状态，并展示“当前块 + Next5”的完整摆法
3. **快照历史回看**：上一条/下一条快照切换，看到当时的建议
4. **两套目标预设**：40L / 对战（先做 T-spin 风格）
5. **离线 AI 引擎接口**：先用占位引擎跑通，再接 cold-clear（WASM）
6. **Next5 + 7-bag 推断（增强）**：在只看 Next5 的基础上，用 7-bag 规则做更靠谱的“远期猜测”

---

## 影响范围
- **模块:**
  - state：从页面提取棋盘/当前块/Hold/Next
  - engine：离线计算建议与完整摆法
  - ui：叠加层 + 弹窗详情页（参考 `ref/tetrismind/` 的前端风格与结构）
- **文件（预估）:**
  - `extension/manifest.json`
  - `extension/src/injected/*`（页面内 Hook）
  - `extension/src/content/*`（叠加层桥接与绘制）
  - `extension/src/engine/*`（Worker + WASM）
  - `extension/src/background/*`（存设置/存快照）
  - `extension/ui/*`（扩展 UI：弹窗/详情页/设置页）
- **API:** 扩展内部消息协议（见 `helloagents/wiki/api.md`）
- **数据:** 设置与快照存储（见 `helloagents/wiki/data.md`）

---

## 核心场景

### 需求: 实时叠加层（实时）
**模块:** ui/state/engine  
在游戏界面上，只显示“当前块”的建议落点。

#### 场景: 40L 游戏中持续提示
在 40L 过程中：
- 预期结果：每次刷新当前块时，提示能跟上（允许有轻微延迟，但不要卡）
- 预期结果：提示位置正确（与棋盘坐标对齐）

#### 场景: 对战中持续提示（先做 T-spin 风格）
- 预期结果：建议更偏向保留 T-spin 形状与安全通道

### 需求: 详情页（快照，不实时）
**模块:** ui/state/engine/background  
用户点开扩展时，抓一份当下快照，并展示“当前块 + Next5”的完整摆法。

#### 场景: 打开详情页生成快照
- 预期结果：打开时立刻保存快照（包含状态 + 当时建议）
- 预期结果：详情页不实时更新（一直显示打开那一刻）

#### 场景: 回看上一条快照
- 预期结果：可以回到上一条快照，并看到当时的完整摆法建议

### 需求: Next5 + 7-bag 推断（增强）
**模块:** engine  
Next 只显示 5 个，但 7-bag 规则可以帮助我们“更合理”地猜后续块。

#### 场景: next 之外的远期规划
- 预期结果：引擎能在 next5 基础上，做多种可能未来的估计（而不是瞎猜一个固定序列）

---

## 风险评估
- **风险:** TETR.IO 更新导致状态结构变化  
  **缓解:** 做版本/特征探测；读不到就自动关闭叠加层并提示
- **风险:** 计算太重导致卡顿  
  **缓解:** Worker 里算；做节流；必要时降低搜索深度
- **风险:** 在竞技匹配/排位使用可能违反规则  
  **缓解:** 默认谨慎禁用；明确提示风险；只做提示不做自动操作
